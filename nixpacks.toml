[phases.setup]
nixPkgs = ["nodejs_22"]

[phases.install]
cmds = [
  "apt-get update && apt-get install -y --no-install-recommends cron curl && rm -rf /var/lib/apt/lists/* || true",
  "npm ci"
]

[phases.build]
cmds = [
  "chmod +x scripts/cron/liquidar.sh || true",
  "chmod +x scripts/cron/descarga-relatorio.sh || true",
  "chmod +x scripts/cron/bingo-auto-sortear.sh || true",
  "chmod +x scripts/start-with-cron.sh || true",
  "mkdir -p /var/log && touch /var/log/liquidar.log && touch /var/log/descarga-relatorio.log || true",
  "echo '*/5 * * * * /app/scripts/cron/liquidar.sh >> /var/log/liquidar.log 2>&1' | crontab - || true",
  "echo '* * * * * /app/scripts/cron/descarga-relatorio.sh >> /var/log/descarga-relatorio.log 2>&1' | crontab - || true",
  "npx prisma generate",
  "npm run build"
]

[start]
cmd = "bash -c 'if command -v crond &> /dev/null; then crond -f -d 8 & fi; if command -v cron &> /dev/null; then cron & fi; sleep 2; exec npm start'"

[staticAssets]
"public" = "./public"
