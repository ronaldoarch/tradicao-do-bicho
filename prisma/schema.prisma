// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Banner {
  id          Int      @id @default(autoincrement())
  title       String?
  text        String?
  bonus       String?
  logoImage   String?
  bannerImage String?
  active      Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Story {
  id        Int      @id @default(autoincrement())
  title     String?  @default("")
  image     String
  alt       String?  @default("")
  active    Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Modalidade {
  id        Int      @id @default(autoincrement())
  name      String
  value     String
  hasLink   Boolean  @default(false)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Promocao {
  id        Int      @id @default(autoincrement())
  tipo      String // 'dobro', 'percentual', 'fixo', 'cashback'
  valor     Float
  titulo    String?
  descricao String?
  active    Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Extracao {
  id        Int      @id @default(autoincrement())
  name      String
  time      String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cotacao {
  id        Int      @id @default(autoincrement())
  name      String?
  value     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tema {
  id              String   @id @default(uuid())
  nome            String
  primaria        String   @default("#052370")
  secundaria      String   @default("#FFD700")
  acento          String   @default("#FF4444")
  sucesso         String   @default("#25D366")
  texto           String   @default("#1C1C1C")
  textoSecundario String   @default("#4A4A4A")
  textoLink       String   @default("#052370")
  textoParagrafo  String   @default("#1C1C1C")
  textoTitulo     String   @default("#1C1C1C")
  fundo           String   @default("#F5F5F5")
  fundoSecundario String   @default("#FFFFFF")
  ativo           Boolean  @default(false)
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
}

model Configuracao {
  id              Int      @id @default(autoincrement())
  nomePlataforma  String   @default("Tradição do Bicho")
  numeroSuporte   String   @default("(00) 00000-0000")
  emailSuporte    String   @default("suporte@tradicaodobicho.com")
  whatsappSuporte String   @default("5500000000000")
  logoSite        String?  @default("")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ConfiguracaoDescarga {
  id                     Int       @id @default(autoincrement())
  whatsappNumero         String // Número WhatsApp para receber relatórios (formato: 5511999999999)
  ativo                  Boolean   @default(true)
  minutosAntesFechamento Int       @default(10) // Minutos antes do fechamento para enviar
  ultimoEnvio            DateTime? // Última vez que foi enviado relatório
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
}

model ConfiguracaoTracking {
  id                  Int      @id @default(autoincrement())
  facebookPixelId     String? // ID do Pixel do Facebook
  facebookAccessToken String? // Token de acesso do Facebook
  webhookUrl          String? // URL do webhook para receber todos os eventos
  ativo               Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ConfiguracaoGatebox {
  id        Int      @id @default(autoincrement())
  username  String?  // CNPJ ou username fornecido pela Gatebox
  password  String?  // Senha fornecida pela Gatebox (criptografada)
  baseUrl   String   @default("https://api.gatebox.com.br")
  ativo     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConfiguracaoFrk {
  id                  Int      @id @default(autoincrement())
  baseUrl             String   @default("https://frkentrypoint.com/ws.svc")
  grant               String?  // Grant fornecido pelo sistema de integração
  codigoIntegrador    String?  // Código do integrador
  sistemaId           Int      @default(9) // Sempre 9
  clienteId           Int?     // Cliente_ID (2853 conforme imagem)
  bancaId             Int?     // Banca_ID (igual ao Cliente_ID)
  chrSerial           String?  // Serial do terminal
  chrCodigoPonto      String?  // Código do ponto
  chrCodigoOperador   String?  // Código do operador
  vchVersaoTerminal   String   @default("1.0.0")
  ativo               Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Gateway {
  id        Int      @id @default(autoincrement())
  name      String   // Nome do gateway (ex: "Gatebox", "SuitPay")
  type      String   @default("suitpay") // "gatebox" ou "suitpay"
  baseUrl   String
  apiKey    String?  // Para SuitPay (Client ID + Secret separados por |)
  username  String?  // Para Gatebox (CNPJ/username)
  password  String?  // Para Gatebox (senha criptografada)
  sandbox   Boolean  @default(true)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Usuario {
  id                 Int            @id @default(autoincrement())
  nome               String
  email              String         @unique
  cpf                String?        @unique // CPF único para validar uma conta por CPF
  telefone           String?
  passwordHash       String?
  saldo              Float          @default(0) // Saldo total (inclui prêmios + depósitos)
  saldoSacavel       Float          @default(0) // Saldo que pode ser sacado (apenas prêmios de apostas)
  bonus              Float          @default(0) // Bônus liberado (não sacável)
  bonusBloqueado     Float          @default(0) // Bônus bloqueado (não sacável)
  rolloverNecessario Float          @default(0) // quanto precisa apostar para liberar o bônus
  rolloverAtual      Float          @default(0) // quanto já apostou que conta para o rollover
  bonusSemanal       Int            @default(0)
  isAdmin            Boolean        @default(false)
  ativo              Boolean        @default(true)
  saques             Saque[]
  apostas            Aposta[]
  transacoes         Transacao[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  CartelaBingo       CartelaBingo[]
}

model Aposta {
  id              Int       @id @default(autoincrement())
  usuarioId       Int
  concurso        String?
  loteria         String?
  estado          String?
  horario         String?
  dataConcurso    DateTime?
  modalidade      String?
  aposta          String?
  valor           Float     @default(0)
  retornoPrevisto Float     @default(0)
  status          String    @default("pendente")
  detalhes        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
}

model Saque {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  valor     Float
  status    String   @default("pendente") // pendente, aprovado, rejeitado
  motivo    String?
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
}

model Transacao {
  id                Int      @id @default(autoincrement())
  usuarioId         Int
  tipo              String // 'deposito', 'saque', etc.
  status            String   @default("pendente") // pendente, pago, falhou
  valor             Float
  gatewayId         Int?
  descricao         String?
  bonusAplicado     Float    @default(0)
  referenciaExterna String?
  usuario           Usuario  @relation(fields: [usuarioId], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([usuarioId])
}

model LimiteDescarga {
  id         Int      @id @default(autoincrement())
  modalidade String // Ex: 'GRUPO', 'DUPLA_GRUPO', 'MILHAR', etc.
  premio     Int // 1, 2, 3, 4, 5 (posição do prêmio)
  limite     Float // Limite máximo em R$
  ativo      Boolean  @default(true)
  loteria    String   @default("") // Loteria/extracao - "" para limite geral
  horario    String   @default("") // Horário da extração - "" para limite geral
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([modalidade, premio, loteria, horario])
  @@index([modalidade])
  @@index([loteria, horario, premio])
}

model NumeroBloqueado {
  id          Int      @id @default(autoincrement())
  modalidade  String // Nome da modalidade
  premio      Int // 1 ao 5 (prêmio)
  numero      String // Número bloqueado (milhar/centena/dezena)
  loteria     String // Loteria/extracao
  horario     String // Horário da extração
  valorAtual  Float // Valor total apostado neste número
  limite      Float // Limite que foi atingido
  bloqueadoEm DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([modalidade, premio, numero, loteria, horario])
  @@index([modalidade, premio, loteria, horario])
  @@index([numero])
}

model AlertaDescarga {
  id            Int       @id @default(autoincrement())
  modalidade    String
  premio        Int
  limite        Float
  totalApostado Float
  excedente     Float // Valor que ultrapassou o limite
  dataConcurso  DateTime? // Data do concurso relacionado
  resolvido     Boolean   @default(false)
  resolvidoEm   DateTime?
  resolvidoPor  Int? // ID do admin que resolveu
  loteria       String? // Loteria/extracao - null para alerta geral
  horario       String? // Horário da extração - null para alerta geral
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([modalidade, premio])
  @@index([resolvido])
  @@index([dataConcurso])
}

model SalaBingo {
  id                     Int       @id @default(autoincrement())
  nome                   String
  descricao              String?
  valorCartela           Float     @default(0)
  premioTotal            Float     @default(0)
  premioLinha            Float     @default(0)
  premioColuna           Float     @default(0)
  premioDiagonal         Float     @default(0)
  premioBingo            Float     @default(0)
  ativa                  Boolean   @default(true)
  emAndamento            Boolean   @default(false)
  dataInicio             DateTime?
  dataFim                DateTime?
  numerosSorteados       Json? // Array de números sorteados
  resultadoFinal         Json? // Resultado final do bingo
  // Configuração de sorteios automáticos
  sorteioAutomatico      Boolean   @default(false) // Se os sorteios são automáticos
  intervaloSorteio       Int       @default(30) // Intervalo entre sorteios em segundos
  proximoSorteio         DateTime? // Próximo horário de sorteio automático
  // Usuários fake vencedores (para exibir como ganhadores)
  usuariosFakeVencedores Json? // Array de { nome: string, tipo: 'linha'|'coluna'|'diagonal'|'bingo', avatar?: string }
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  cartelas   CartelaBingo[]
  resultados ResultadoBingo[]

  @@index([ativa])
  @@index([emAndamento])
  @@index([emAndamento, sorteioAutomatico])
}

model CartelaBingo {
  id             Int      @id @default(autoincrement())
  salaId         Int
  usuarioId      Int
  numeros        Json // Matriz 5x5 com os números da cartela
  valorPago      Float    @default(0)
  status         String   @default("ativa") // ativa, ganhou, perdida
  premioRecebido Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sala    SalaBingo @relation(fields: [salaId], references: [id], onDelete: Cascade)
  usuario Usuario   @relation(fields: [usuarioId], references: [id])

  @@index([salaId])
  @@index([usuarioId])
  @@index([status])
}

model ResultadoBingo {
  id                 Int      @id @default(autoincrement())
  salaId             Int
  tipo               String // "linha", "coluna", "diagonal", "bingo"
  numerosGanhadores  Json // Números que completaram o tipo
  cartelasGanhadoras Json // IDs das cartelas ganhadoras
  premioTotal        Float    @default(0)
  createdAt          DateTime @default(now())

  sala SalaBingo @relation(fields: [salaId], references: [id], onDelete: Cascade)

  @@index([salaId])
  @@index([tipo])
}

model WebhookEvent {
  id          Int       @id @default(autoincrement())
  source      String // Origem do webhook (ex: "receba", "stripe", "pagseguro")
  eventType   String // Tipo do evento (ex: "deposit", "payment", "refund")
  payload     Json // Payload completo recebido
  headers     Json? // Headers da requisição
  status      String    @default("received") // received, processed, failed
  statusCode  Int? // Status code da resposta
  response    Json? // Resposta enviada
  error       String? // Mensagem de erro se houver
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([source])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
}

model FacebookEvent {
  id          Int       @id @default(autoincrement())
  eventName   String // Nome do evento (ex: "PageView", "Purchase", "Lead")
  eventId     String?   @unique // ID único do evento do Facebook
  pixelId     String? // ID do pixel do Facebook
  userData    Json? // Dados do usuário (email, phone, etc)
  customData  Json? // Dados customizados do evento
  value       Float? // Valor do evento (para eventos de conversão)
  currency    String? // Moeda
  sourceUrl   String? // URL de origem
  userAgent   String? // User agent
  ipAddress   String? // IP do usuário
  status      String    @default("received") // received, processed, failed
  error       String? // Mensagem de erro se houver
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([eventName])
  @@index([pixelId])
  @@index([status])
  @@index([createdAt])
  @@index([eventId])
}
